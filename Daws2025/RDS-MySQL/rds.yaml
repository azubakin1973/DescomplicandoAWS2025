# aws cloudformation deploy --stack-name rds-mysql-simple-db --template-file Daws2025/Cloudformation/RDS-MySQL/rds.yaml --parameter-overrides DBPassword=Moraes1208*

AWSTemplateFormatVersion: '2010-09-09'
Description: Simple MySQL

Parameters:
  EnvId:
    Type: String
    Default: project
    Description: Tag value for Application

  DBUsername:
    Type: String
    Default: admin
    MinLength: 1
    MaxLength: 16
    AllowedPattern: '^[a-zA-Z][a-zA-Z0-9_]*$'
    Description: Master username (starts with a letter; alphanumeric/underscore)

  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 41
    Description: Master user password

  DBInstanceClass:
    Type: String
    Default: db.t3.micro
    Description: Instance class (db.t3.micro recommended for free tier)

  AllowedCidr:
    Type: String
    Default: "0.0.0.0/0"
    Description: Optional CIDR (e.g., 203.0.113.0/24) allowed to access MySQL (3306). Leave empty to disable inbound.
  
  PubliclyAccessible:
    Type: String
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Whether the DB instance should have a public IP

Conditions:
  IsPubliclyAccessible: !Equals [!Ref PubliclyAccessible, "true"]
  

Resources:
  DbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: MySQL access
      VpcId:
        Fn::ImportValue: !Sub '${EnvId}-VpcId'
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: EnvId
          Value: !Ref EnvId

  DbSgIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref DbSecurityGroup
      IpProtocol: tcp
      FromPort: 3306
      ToPort: 3306
      CidrIp: !Ref AllowedCidr

  DbSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnets for MySQL
      SubnetIds:
        - Fn::ImportValue: !Sub "${EnvId}-PublicSubnet1Id"
        - Fn::ImportValue: !Sub "${EnvId}-PublicSubnet2Id"
        - Fn::ImportValue: !Sub "${EnvId}-PublicSubnet3Id"
      Tags:
        - Key: EnvId
          Value: !Ref EnvId

  DbInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Engine: mysql
      DBInstanceClass: !Ref DBInstanceClass
      DBInstanceIdentifier: !Sub "${EnvId}-mysql-db"
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      DBName: mysqldb
      DBSubnetGroupName: !Ref DbSubnetGroup
      VpcSecurityGroupIds: [!Ref DbSecurityGroup]
      PubliclyAccessible: !If [IsPubliclyAccessible, true, false]
      Port: 3306
      AllocatedStorage: 20
      StorageType: gp2
      BackupRetentionPeriod: 1
      DeletionProtection: false
      AutoMinorVersionUpgrade: true
      Tags:
        - Key: EnvId
          Value: !Ref EnvId

Outputs:
  DBInstanceId:
    Description: DB instance identifier
    Value: !Ref DbInstance
  
  Endpoint:
    Description: DB instance endpoint address
    Value: !GetAtt DbInstance.Endpoint.Address
  
  Port:
    Description: DB instance port
    Value: !GetAtt DbInstance.Endpoint.Port
  
  SecurityGroupId:
    Description: DB security group ID
    Value: !Ref DbSecurityGroup
